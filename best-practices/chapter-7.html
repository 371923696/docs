

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
    <meta charset="utf-8">
    
    <meta name="viewport" content="width=375,user-scalable=no">
    
    <title>4.1.7. SQL查询调优 &mdash; HashData Warehouse Document 1.0.0 文档</title>
    

    
    

    

    
    
    

    

    
    
    <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
    

    

    
    <link rel="index" title="索引"
          href="../genindex.html"/>
    <link rel="search" title="搜索" href="../search.html"/>
    <link rel="top" title="HashData Warehouse Document 1.0.0 文档" href="../index.html"/>
    <link rel="up" title="4. 最佳实践" href="index.html"/>
    <link rel="next" title="4.1.8. 导入数据到HashData" href="data-ingest-1.html"/>
    <link rel="prev" title="4.1.6. 加载数据" href="chapter-6.html"/> 

    
    <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

    <div id="header">
        <header class="navbar navbar-static-top navbar-fixed-top" id="top" role="banner">
            <div class="container">
                <div class="navbar-header">
                    <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="http://www.hashdata.cn">
                        <img alt="Brand" src="../_static/img/logo.png">
                    </a>
                </div>
                <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
                    <ul class="nav navbar-nav navbar-right">
                        <li id="nav-index">
                            <a href="http://www.hashdata.cn">首页</a>
                        </li>
                        <li id="nav-product">
                            <a href="http://www.hashdata.cn/product">产品</a>
                        </li>
                        <li id="nav-case">
                            <a href="http://www.hashdata.cn/case">案例</a>
                        </li>
                        <li id="nav-blog">
                            <a href="http://www.hashdata.cn/blog">博客</a>
                        </li>
                        <li id="nav-doc" class="active">
                            <a href="http://www.hashdata.cn/docs">文档</a>
                        </li>
                        <li class="dropdown" id="nav-aboutus">
                            <a href="aboutus" class="dropdown-toggle" data-toggle="dropdown">酷克数据<span class="caret"></span></a>
                            <ul class="dropdown-menu" role="menu">
                                <li><a href="http://www.hashdata.cn/#block-aboutus-img">关于我们</a></li>
                                <li><a href="http://www.hashdata.cn/aboutus">加入我们</a></li>
                                <li> <a href="http://www.greenplum.net.cn/" target=_blank>社区</a></li>
                            </ul>
                        </li>
                        <li class="try">
			    <a target="_blank" href="https://appcenter.qingcloud.com/apps/app-iwacxg9z">点击试用</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </header>
    </div>

        <div id="m-header">
	    <nav id="m-nav">
		<button id="m-nav-btn">
		    <span class="icon-bar"></span>
		    <span class="icon-bar"></span>
		    <span class="icon-bar"></span>
		</button>
            <div class="wy-nav-top-search">
                
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <img src="../_static/img/search-icon.png" alt="search" />
    <input type="text" name="q" placeholder="搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
            </div>
	    </nav>
	    <div id="m-index">
		<ul>
		    <li class=""><a href="http://www.hashdata.cn/">首页</a></li>
		    <li class=""><a href="http://www.hashdata.cn/product">产品</a></li>
		    <li class=""><a href="http://www.hashdata.cn/case">案例</a></li>
		    <li class=""><a href="http://www.hashdata.cn/blog">博客</a></li>
		    <li class="active"><a href="http://www.hashdata.cn/docs">文档</a></li>
		    <li class=""><a href="http://www.hashdata.cn/#block-aboutus-img">关于我们</a></li>
		    <li class=""><a href="http://www.hashdata.cn/aboutus">加入我们</a></li>
		</ul>
	    </div>
	</div>


    <div id="content">

<div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
        <div class="wy-side-scroll">
            <div class="topLevel">
                
                
                
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../getting-started-guide/hashdata_warehouse_guide.html">1. 入门指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cluster-management-guide/cluster-management-guide.html">2. 管理指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer-guide/index.html">3. 开发指南</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">4. 最佳实践</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data-subscription-guide/index.html">5. 数据订阅服务</a></li>
</ul>

                
                
            </div>

            <div class="wy-side-nav-search">
                

                <!---->
                <!--<a href="../index.html" class="icon icon-home"> HashData Warehouse Document-->
                <!---->

                <!---->
                <!--</a>-->

                <!---->
                <!---->
                <!---->
                <!---->
                <!--<div class="version">-->
                <!--1.0.0-->
                <!--</div>-->
                <!---->
                <!---->

                
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <img src="../_static/img/search-icon.png" alt="search" />
    <input type="text" name="q" placeholder="搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

                
            </div>

            <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                
                
                
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../getting-started-guide/hashdata_warehouse_guide.html">1. 入门指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cluster-management-guide/cluster-management-guide.html">2. 管理指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer-guide/index.html">3. 开发指南</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">4. 最佳实践</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html#product-name">4.1. HashData 数据仓库 最佳实践</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="chapter-1.html">4.1.1. 最佳实践提纲</a></li>
<li class="toctree-l3"><a class="reference internal" href="chapter-2.html">4.1.2. 系统配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="chapter-3.html">4.1.3. 数据库模式设计</a></li>
<li class="toctree-l3"><a class="reference internal" href="chapter-4.html">4.1.4. 内存和负载管理</a></li>
<li class="toctree-l3"><a class="reference internal" href="chapter-5.html">4.1.5. 系统监控和维护</a></li>
<li class="toctree-l3"><a class="reference internal" href="chapter-6.html">4.1.6. 加载数据</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">4.1.7. SQL查询调优</a></li>
<li class="toctree-l3"><a class="reference internal" href="data-ingest-1.html">4.1.8. 导入数据到HashData</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../data-subscription-guide/index.html">5. 数据订阅服务</a></li>
</ul>

                
                
            </div>
        </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

        
        
        
        
        
        
        


        
        <div class="topLevel m-topLevel">
            
            
            <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../getting-started-guide/hashdata_warehouse_guide.html">1. 入门指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cluster-management-guide/cluster-management-guide.html">2. 管理指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer-guide/index.html">3. 开发指南</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">4. 最佳实践</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data-subscription-guide/index.html">5. 数据订阅服务</a></li>
</ul>

            
        </div>

        
        <div class="wy-nav-content">
            <div class="rst-content">
                

<!-- -->
<!---->
<!---->

<!--<div role="navigation" aria-label="breadcrumbs navigation">-->
  <!--<ul class="wy-breadcrumbs">-->
    <!--<li><a href="../index.html">Docs</a> &raquo;</li>-->
      <!---->
          <!--<li><a href="index.html">4. 最佳实践</a> &raquo;</li>-->
      <!---->
    <!--<li>4.1.7. SQL查询调优</li>-->
      <!--<li class="wy-breadcrumbs-aside">-->
        <!---->
          <!---->
            <!--<a href="../_sources/best-practices/chapter-7.rst.txt" rel="nofollow"> View page source</a>-->
          <!---->
        <!---->
      <!--</li>-->
  <!--</ul>-->
  <!--<hr/>-->
<!--</div>-->
                <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
                    <div itemprop="articleBody">
                        
  <div class="section" id="sql">
<h1>4.1.7. SQL查询调优<a class="headerlink" href="#sql" title="永久链接至标题">¶</a></h1>
<p>HashData 数据仓库 采用基于成本的优化器来评估执行查询的不同策略，并选择成本最低的方法。和其他关系数据库系统的优化器相似，在计算不同执行计划的成本时，HashData 数据仓库 的优化器会考虑诸如关联表的行数、是否有索引、字段数据的基数等因素。还会考虑到数据的位置，尽可能在段数据库(Segment)上完成任务，降低在不同Segments间传输的数据量。</p>
<p>在一个查询运行速度比预期慢时，可以查看优选器生成的查询计划以及执行每一步的代价。这有助于确定哪一步最耗资源，进而可以修改查询或者模式，以便生成更好的计划。查看查询计划使用EXPLAIN语句。</p>
<p>优化器基于每个表的统计信息生成计划，所以准确的统计信息对生成最有计划至关重要。关于更新统计信息，请参看本文档的”使用ANALYZE更新统计信息”一节。</p>
<div class="section" id="id1">
<h2>4.1.7.1. 生成查询计划<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<p>EXPLAIN和EXPLAIN ANALYZE语句有助于改进查询性能。EXPLAIN显示一个查询的执行计划以及估算的代价，但是不执行该查询。EXPLAIN ANALYZE除了显示执行计划外还会执行查询。EXPLAIN ANALYZE会丢弃SELECT语句的输出，其他操作会被执行（例如INSERT，UPDATE和DELETE）。若需对DML语句使用EXPLAIN ANALYZE而不影响数据，可置EXPLAIN ANALYZE于事务中（BEGIN; EXPLAIN ANALYZE …; ROLLBACK;）。</p>
<p>EXPLAIN ANALYZE除了执行查询、显示查询计划外，还显示如下信息：</p>
<ul class="simple">
<li>执行查询的总时间（以毫秒为单位）；</li>
<li>查询节点需要的工作进程个数；</li>
<li>每个操作中处理最多行的Segment处理的最大行数以及Segment的序号；</li>
<li>内存使用量；</li>
<li>从处理最多行的Segment上获得第一行花费的时间（单位是毫秒）及从该Segment获得所有行花费的时间。</li>
</ul>
</div>
<div class="section" id="id2">
<h2>4.1.7.2. 理解查询计划<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<p>解释计划详细描述了|product-name| 执行查询的步骤。查询计划是颗节点树，从下向上读数据，每个节点将它的执行结果数据传递给其上的节点。每个节点表示查询计划的一个步骤，每个节点都有一行信息描述了该步骤执行的操作 – 例如扫描、关联、聚合或者排序操作等，此外还有显示执行该操作的具体方法。例如，扫描操作可能是顺序扫描或者索引扫描，关联操作可能是哈希关联或者嵌套循环关联。</p>
<p>下面是一个简单查询的解释计划，这个查询的结果应为每个Segment上contributions表的行数。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">gpacmin</span><span class="o">=#</span> <span class="k">EXPLAIN</span> <span class="k">SELECT</span> <span class="n">gp_Segment_id</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
                  <span class="k">FROM</span> <span class="n">contributions</span>
                  <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">gp_Segment_id</span><span class="p">;</span>
                                                                    <span class="n">QUERY</span> <span class="n">PLAN</span>
<span class="c1">--------------------------------------------------------------------------------</span>
<span class="n">Gather</span> <span class="n">Motion</span> <span class="mi">2</span><span class="p">:</span><span class="mi">1</span> <span class="p">(</span><span class="n">slice2</span><span class="p">;</span> <span class="n">Segments</span><span class="p">:</span> <span class="mi">2</span><span class="p">)</span> <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">4</span><span class="p">.</span><span class="mi">44</span> <span class="k">rows</span><span class="o">=</span><span class="mi">4</span> <span class="n">width</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="o">-&gt;</span> <span class="n">HashAggregate</span> <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">3</span><span class="p">.</span><span class="mi">38</span> <span class="k">rows</span><span class="o">=</span><span class="mi">4</span> <span class="n">width</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="k">Group</span> <span class="k">By</span><span class="p">:</span> <span class="n">contributions</span><span class="p">.</span><span class="n">gp_Segment_id</span>
        <span class="o">-&gt;</span> <span class="n">Redistribute</span> <span class="n">Motion</span> <span class="mi">2</span><span class="p">:</span><span class="mi">2</span> <span class="p">(</span><span class="n">slice1</span><span class="p">;</span> <span class="n">Segments</span><span class="p">:</span> <span class="mi">2</span><span class="p">)</span> <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">2</span><span class="p">.</span><span class="mi">12</span> <span class="k">rows</span><span class="o">=</span><span class="mi">4</span> <span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
            <span class="n">Hash</span> <span class="k">Key</span><span class="p">:</span> <span class="n">contributions</span><span class="p">.</span><span class="n">gp_Segment_id</span>
            <span class="o">-&gt;</span> <span class="n">Sequence</span> <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">1</span><span class="p">.</span><span class="mi">09</span> <span class="k">rows</span><span class="o">=</span><span class="mi">4</span> <span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
                <span class="o">-&gt;</span> <span class="k">Result</span> <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">10</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">100</span><span class="p">.</span><span class="mi">00</span> <span class="k">rows</span><span class="o">=</span><span class="mi">50</span> <span class="n">width</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
                    <span class="o">-&gt;</span> <span class="k">Function</span> <span class="n">Scan</span> <span class="k">on</span> <span class="n">gp_partition_expansion</span> <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">10</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">100</span><span class="p">.</span><span class="mi">00</span> <span class="k">rows</span><span class="o">=</span><span class="mi">50</span> <span class="n">width</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
                <span class="o">-&gt;</span> <span class="k">Dynamic</span> <span class="k">Table</span> <span class="n">Scan</span> <span class="k">on</span> <span class="n">contributions</span> <span class="p">(</span><span class="n">partIndex</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span> <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="p">..</span><span class="mi">0</span><span class="p">.</span><span class="mi">03</span> <span class="k">rows</span><span class="o">=</span><span class="mi">4</span> <span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
<span class="n">Settings</span><span class="p">:</span> <span class="n">optimizer</span><span class="o">=</span><span class="k">on</span><span class="p">(</span><span class="mi">10</span> <span class="k">rows</span><span class="p">)</span>
</pre></div>
</div>
<p>此计划有7个节点 - Dynamic Table Scan, Function Scan, Result, Sequence, Redistribute Motion, HashAggregate 及最后的 Gather Motion。每个节点含有三个估计代价：代价（顺序读页数），行数和行的长度。</p>
<p>代价本身包含2个估计值。一部分是启动代价估计，即得到第一行的代价，第二部分是总代价估计，即处理完所有行的代价。代价为1.0意味着顺序读一个磁盘页。</p>
<p>行数是查询节点输出行数的估计。考虑到 WHERE 子句条件的选择性，可能比实际处理或者扫描的行数小。总代价假设处理所有行，而有些时候可能不需要（例如 LIMIT 子句）。</p>
<p>长度是查询节点输出的所有字段的总长度，单位是字节。</p>
<p>节点的估计代价包括所有子节点的代价，所以计划的最顶层节点（通常是 Gather Motion）包含执行计划的总代价。优化器试图降低的也正是这个数字。</p>
<p>扫描操作符扫描数据库表以找到期望的数据行。不同的存储类型有不同的扫描操作：</p>
<ul>
<li><p class="first">堆表顺序扫描 - 扫描表的所有行</p>
</li>
<li><p class="first">AO 扫描 - 扫描面向行的AO表</p>
</li>
<li><p class="first">AO 列扫描 - 扫描面向列的AO表</p>
</li>
<li><p class="first">索引扫描 - 遍历B树索引，从表中获取期望的行</p>
</li>
<li><p class="first">Bitmap AO 行扫描 - 从索引中获得AO表行的指针，并根据磁盘位置排序</p>
</li>
<li><p class="first">动态扫描 - 使用分区选择函数选择待扫描的分区。Function Scan 节点包含分区选择函数的名字：</p>
<blockquote>
<div><ol class="arabic simple">
<li>gp_partition_expansion- 选择表的所有分区，不会裁剪分区</li>
<li>gp_partition_selection- 根据等价表达式选择分区</li>
<li>gp_partition_inversion- 根据范围表达式选择分区</li>
</ol>
</div></blockquote>
</li>
</ul>
<p>Function Scan 节点将动态选择的分区传递个 Result 节点，进而传递给 Sequence 节点。</p>
<p>关联操作符：</p>
<ul class="simple">
<li>哈希关联 - 用关联字段做哈希键，对小表建立哈希表。然后扫描大表，计算大表每行关联字段的哈希键，从哈希表中查找哈希值相同的行。通常哈希关联是速度最快的关联方式。查询计划中的Hash Cond是关联字段。</li>
<li>嵌套循环 - 遍历大数据集，对其每一行，扫描小数据集，并找到匹配的行。嵌套循环关联需要广播一个表的数据，以便另一个表的数据可以和该表的每一行进行比较。对于小表或者使用索引的表性能良好。也用于笛卡尔关联和范围关联。对大表使用嵌套关联性能不佳。如果查询节点使用嵌套循环关联操作符，则检查SQL，确保结果是期望的。设置配置参数 <em>enable_nestloop</em> 为 OFF （默认）以优先使用哈希关联。</li>
<li>合并关联 - 对两个数据集排序，然后合并。合并关联对已经排序的数据性能很好，但是较少使用。如要使用合并关联，设置 <em>enable_mergejoin</em> 为 ON。</li>
</ul>
<p>某些查询计划节点是移动操作符(Motion)。移动操作符负责在段数据库（Segment）间传输行数据。这种节点会标识执行移动操作的方法：</p>
<blockquote>
<div><ul class="simple">
<li>广播：每个Segment发送其表数据给所有其他Segments，这样每个Segment都有该表的完整本地拷贝。广播移动操作比充分发移动操作符效率低，所以优化器仅仅对小表使用广播操作，广播大表性能欠佳。</li>
<li>重分发：每个Segment对数据关联字段计算哈希值，并发送到对应的Segments。</li>
<li>收集：所有Segments的结果数据发送给单个节点，这通常是大多数查询计划的最后一步。</li>
</ul>
</div></blockquote>
<p>其他操作符有：</p>
<ul class="simple">
<li>物化（Material） - 优化器物化子查询，避免多次使用时重复计算。</li>
<li>InitPlan - 仅仅需要执行一次的子查询，且对外围查询没有依赖。</li>
<li>排序（Sort） - 对数据集排序，多用于为聚合或者合并关联准备数据。</li>
<li>分组（Group By）- 根据一个或者多个字段对数据集分组。</li>
<li>分组/哈希聚合（Aggregation）- 使用哈希对数据集进行聚合计算。</li>
<li>追加（Append）- 合并数据集，例如当扫描分区表的多个分区时。</li>
<li>过滤器 (Filter) - 根据 WHERE 子句条件选择匹配的数据行。</li>
<li>限制（Limit）- 限制返回的行数。</li>
</ul>
</div>
<div class="section" id="id3">
<h2>4.1.7.3. 优化查询<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<p>本节介绍某些情况下可以改善系统性能的数据库特性和编程实践。</p>
<p>分析查询计划时首先需找估计代价很高的操作。对比估算的行数及代价与操作实际需要处理的行数，以判断是否合理。</p>
<p>如果有分区表，判断分区裁剪是否有效。分区裁剪需要查询条件（WHERE 子句）必须和分区条件一样。此外，WHERE子句不能含有显式值，也不能包含子查询。</p>
<p>检查查询计划树的执行顺序，检查行数估计值。希望先处理小表，或者哈希关联的结果集，然后处理大表。理想情况是最后处理最大的表，以降低沿着查询树向上传递直到最顶层节点的行数。如果执行计划顺序不是最优的，检查数据库统计信息是否最新的。运行ANALYZE通常会解决这个问题，并生成最优计划。</p>
<p>注意计算倾斜。当执行诸如哈希聚合和哈希关联等操作符时，若不同Segments执行代价分布不均，则发生计算倾斜。由于某些Segment比其他Segment使用更多的CPU和内存，性能下降明显。原因可能是关联、排序、聚合字段基数低或者分布不均匀。通过 EXPLAIN ANALYZE 输出可以检测计算倾斜。每个节点都含有Segment处理的最多行数和所有Segment的平均行数。如果最大行数比均值大很多，那么至少有一个Segment需要处理更多的工作，因而有计算倾斜的可能性。</p>
<p>注意执行排序或者聚合操作的查询节点。聚合操作隐含排序操作。如果排序和聚合操作需要处理大量数据，则存在优化查询性能的机会。当需要对大量数据行进行排序和聚合时，优先使用 HashAggregate 操作符。通常情况下，不良SQL会造成优化器选择使用排序操作符。如果重写查询，大多数的排序操作可以被 HashAggregate 替代。设置 <em>enable_groupagg</em> 参数以优先使用 HashAggregate 而非排序聚合操作。</p>
<p>若查询计划显示对大量数据集使用了广播移动操作符，需要尝试避免使用广播操作符。一种方法是使用*gp_segments_for_planner* 配置参数增加移动数据的估计代价。该变量告诉优化器在计算移动代价时使用多少个segments。默认值是0，意味着使用实际Segment个数。增大这个数字，移动的代价会跟着增大，优化器会优先使用重分发移动操作符。例如设置 gp_segments_for_planner=100000 告诉优化器有100000个Segments。相反为了优先使用广播移动操作符，为该值设置一个小数字，例如2。</p>
</div>
<div class="section" id="id4">
<h2>4.1.7.4. 分组扩展<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h2>
<p>HashData 数据仓库 的GROUP BY扩展可以执行某些常用的计算，且比应用程序或者存储过程效率高。</p>
<ul class="simple">
<li>GROUP BY ROLLUP(col1, col2, col3)</li>
<li>GROUP BY CUBE(col1, col2, col3)</li>
<li>GROUP BY GROUPING SETS((col1, col2), (col1, col3))</li>
</ul>
<p>ROLLUP对分组字段（或者表达式）从最详细级别到最顶级别计算聚合计数。ROLLUP的参数是一个有序分组字段列表，它计算从右向左各个级别的聚合。例如 ROLLUP(c1, c2, c3) 会为下列分组条件计算聚集：</p>
<ul class="simple">
<li>(c1, c2, c3)</li>
<li>(c1, c2)</li>
<li>(c1)</li>
<li>()</li>
</ul>
<p>CUBE为分组字段的所有组合计算聚合。例如 CUBE(c1, c2, c3) 会计算一下聚合：</p>
<ul class="simple">
<li>(c1, c2, c3)</li>
<li>(c1, c2)</li>
<li>(c2, c3)</li>
<li>(c1, c3)</li>
<li>(c1)</li>
<li>(c2)</li>
<li>(c3)</li>
<li>()</li>
</ul>
<p>GROUPING SETS 指定对那些字段计算聚合，它可以比 ROLLUP 和 CUBE 更精确地控制分区条件。</p>
<p>更多细节请参见《HashData 数据仓库 参考指南》。</p>
</div>
<div class="section" id="id5">
<h2>4.1.7.5. 窗口函数<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h2>
<p>窗口函数可以实现在结果集的分组子集上的聚合或者排名函数，例如 sum(population) over (partition by city)。窗口函数功能强大，性能优异。因为它在数据库内部进行计算，避免了数据传输。</p>
<ul class="simple">
<li>窗口函数 row_number() 计算一行在分组子集中的行号，例如 row_number() over (order by id)。</li>
<li>如果查询计划显示某个表被扫描多次，那么通过窗口函数可能可以降低扫描次数。</li>
<li>窗口函数通常可以避免使用自关联。</li>
</ul>
</div>
</div>


                    </div>
                </div>
                <footer> 

</footer>

            </div>
        </div>

    </section>

</div>


</div>



<script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
        URL_ROOT:'../',
        VERSION:'1.0.0',
        COLLAPSE_INDEX:false,
        FILE_SUFFIX:'.html',
        HAS_SOURCE:  true
    };
</script>
<script type="text/javascript" src="../_static/jquery.js"></script>
<script type="text/javascript" src="../_static/underscore.js"></script>
<script type="text/javascript" src="../_static/doctools.js"></script>
<script type="text/javascript" src="../_static/translations.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>





<script type="text/javascript" src="../_static/js/theme.js"></script>

<script src="../_static/js/bootstrap/bootstrap.min.js"></script>
<script>

$(function() {
    var triIcon = "../_static/img/tri-icon.png";
    $('.document .section h2').append( '<img src=' + triIcon + ' />' );
    $('.document .section h2').click(function() {
        $(this).parent().toggleClass('closed');
    });
});

$(function(){
    $('#m-nav-btn, #m-index li').click(function(e){
            $('#m-index').slideToggle(300, function(){
                $('#m-index').css('display') == "block" ?
                $('#m-header').css('background-color','#fff') :
                $('#m-header').css('background-color','rgba(255,255,255,0.9)');
            });
        });
        $('#content, #m-footer').click(function(){
            $('#m-index').slideUp();
            $('#m-header').css('background-color','rgba(255,255,255,0.9)')
        });

    /*
    $('.topLevel .toctree-l1 a.reference').each(function(index, ele) {
        var contentStr = ele. innerHTML;
        var aSet = new Set(['1.', '2.', '3.']);
        if (aSet.has(contentStr.substr(0,2)))
            ele.innerHTML = contentStr.substr(2);
    });
    */

});

</script>



<script type="text/javascript">
    jQuery(function () {
        SphinxRtdTheme.StickyNav.enable();
    });
</script>



<div id="footer">
    <footer id="footer-1">
	<div class="container">
	    <div class="footer-block col-lg-3 col-lg-offset-2 col-md-4 col-md-offset-1 col-sm-5 col-xs-5">
		<div class="logo">
		    <img src="../_static/img/footer-logo.png"/>
		</div>
		<p>北京酷克数据科技有限公司</p>
		<p>地址：北京市朝阳区望京洛娃大厦C座6层1603室</p>
	    </div>
	    <div class="footer-block col-lg-3 col-md-4 col-sm-5 col-xs-5">
		<p class="title">联系地址</p>
		<p>电话：010-80699945</p>
		<p>微博：@HashData</p>
		<p>邮件：business@hashdata.cn</p>
	    </div>
	    <div class="footer-block qrcode col-lg-3 col-md-3">
		<p class="title">微信公众号</p>
		<img src="../_static/img/qrcode.png"/>
	    </div>
	</div>
    </footer>
    <footer id="footer-2">
	<p>Copyright © 2016 HashData Ltd. 京ICP备16019672号-1</p>
	<p><span class="emblem"></span>京公安网备11010502031309号</p>
    </footer>
</div>

<div id="m-footer">
    <div id="m-footer-bg"></div>
    <footer id="footer-1">
	<div class="logo"><img src="../_static/img/footer-logo.png" /></div>
	<div class="address">
	    <p>北京酷克数据科技有限公司</p>
	    <p>地址：北京市朝阳区望京洛娃大厦C座6层1603室</p>
	</div>
	<div class="connect">
	    <p class="title">联系地址</p>
	    <p>电话：010-80699945</p>
	    <p>微博：@HashData</p>
	    <p>邮件：business@hashdata.cn</p>
	    <p>扫描二维码关注公众号：</p>
	    <div class="qrcode">
		<img src="../_static/img/qrcode.png"/>
	    </div>
	</div>
    </footer>
    <footer id="footer-2">
	<div class="copyright">
	    <p>Copyright © 2016 HashData Ltd. 京ICP备16019672号-1</p>
	    <p><span></span>京公安网备11010502031309号</p>
	</div>
    </footer>
</div>




</body>
</html>