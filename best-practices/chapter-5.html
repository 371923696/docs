

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
    <meta charset="utf-8">
    
    <meta name="viewport" content="width=375,user-scalable=no">
    
    <title>4.1.5. 第五章 &mdash; HashData Warehouse Document 1.0.0 文档</title>
    

    
    

    

    
    
    

    

    
    
    <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
    

    

    
    <link rel="index" title="索引"
          href="../genindex.html"/>
    <link rel="search" title="搜索" href="../search.html"/>
    <link rel="top" title="HashData Warehouse Document 1.0.0 文档" href="../index.html"/>
    <link rel="up" title="4. 最佳实践" href="index.html"/>
    <link rel="next" title="4.1.6. 第六章" href="chapter-6.html"/>
    <link rel="prev" title="4.1.4. 第四章" href="chapter-4.html"/> 

    
    <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

    <div id="header">
        <header class="navbar navbar-static-top navbar-fixed-top" id="top" role="banner">
            <div class="container">
                <div class="navbar-header">
                    <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="http://www.hashdata.cn">
                        <img alt="Brand" src="../_static/img/logo.png">
                    </a>
                </div>
                <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
                    <ul class="nav navbar-nav navbar-right">
                        <li id="nav-index">
                            <a href="http://www.hashdata.cn">首页</a>
                        </li>
                        <li id="nav-product">
                            <a href="http://www.hashdata.cn/product">产品</a>
                        </li>
                        <li id="nav-case">
                            <a href="http://www.hashdata.cn/case">案例</a>
                        </li>
                        <li id="nav-blog">
                            <a href="http://www.hashdata.cn/blog">博客</a>
                        </li>
                        <li id="nav-doc" class="active">
                            <a href="http://www.hashdata.cn/docs">文档</a>
                        </li>
                        <li class="dropdown" id="nav-aboutus">
                            <a href="aboutus" class="dropdown-toggle" data-toggle="dropdown">酷克数据<span class="caret"></span></a>
                            <ul class="dropdown-menu" role="menu">
                                <li><a href="http://www.hashdata.cn/#block-aboutus-img">关于我们</a></li>
                                <li><a href="http://www.hashdata.cn/aboutus">加入我们</a></li>
                                <li> <a href="http://www.greenplum.net.cn/" target=_blank>社区</a></li>
                            </ul>
                        </li>
                        <li class="try">
			    <a target="_blank" href="https://appcenter.qingcloud.com/apps/app-iwacxg9z">点击试用</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </header>
    </div>

        <div id="m-header">
	    <nav id="m-nav">
		<button id="m-nav-btn">
		    <span class="icon-bar"></span>
		    <span class="icon-bar"></span>
		    <span class="icon-bar"></span>
		</button>
            <div class="wy-nav-top-search">
                
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <img src="../_static/img/search-icon.png" alt="search" />
    <input type="text" name="q" placeholder="搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
            </div>
	    </nav>
	    <div id="m-index">
		<ul>
		    <li class=""><a href="http://www.hashdata.cn/">首页</a></li>
		    <li class=""><a href="http://www.hashdata.cn/product">产品</a></li>
		    <li class=""><a href="http://www.hashdata.cn/case">案例</a></li>
		    <li class=""><a href="http://www.hashdata.cn/blog">博客</a></li>
		    <li class="active"><a href="http://www.hashdata.cn/docs">文档</a></li>
		    <li class=""><a href="http://www.hashdata.cn/#block-aboutus-img">关于我们</a></li>
		    <li class=""><a href="http://www.hashdata.cn/aboutus">加入我们</a></li>
		</ul>
	    </div>
	</div>


    <div id="content">

<div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
        <div class="wy-side-scroll">
            <div class="topLevel">
                
                
                
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../getting-started-guide/hashdata_warehouse_guide.html">1. 入门指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cluster-management-guide/cluster-management-guide.html">2. 管理指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer-guide/index.html">3. 开发指南</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">4. 最佳实践</a></li>
</ul>

                
                
            </div>

            <div class="wy-side-nav-search">
                

                <!---->
                <!--<a href="../index.html" class="icon icon-home"> HashData Warehouse Document-->
                <!---->

                <!---->
                <!--</a>-->

                <!---->
                <!---->
                <!---->
                <!---->
                <!--<div class="version">-->
                <!--1.0.0-->
                <!--</div>-->
                <!---->
                <!---->

                
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <img src="../_static/img/search-icon.png" alt="search" />
    <input type="text" name="q" placeholder="搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

                
            </div>

            <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                
                
                
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../getting-started-guide/hashdata_warehouse_guide.html">1. 入门指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cluster-management-guide/cluster-management-guide.html">2. 管理指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer-guide/index.html">3. 开发指南</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">4. 最佳实践</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html#product-name">4.1. HashData 数据仓库 最佳实践</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="chapter-1.html">4.1.1. HashData 数据仓库 数据仓库最佳实践概述</a></li>
<li class="toctree-l3"><a class="reference internal" href="chapter-2.html">4.1.2. 第二章</a></li>
<li class="toctree-l3"><a class="reference internal" href="chapter-3.html">4.1.3. 第三章</a></li>
<li class="toctree-l3"><a class="reference internal" href="chapter-4.html">4.1.4. 第四章</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">4.1.5. 第五章</a></li>
<li class="toctree-l3"><a class="reference internal" href="chapter-6.html">4.1.6. 第六章</a></li>
<li class="toctree-l3"><a class="reference internal" href="chapter-7.html">4.1.7. 第七章</a></li>
</ul>
</li>
</ul>
</li>
</ul>

                
                
            </div>
        </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

        
        
        
        
        
        
        


        
        <div class="topLevel m-topLevel">
            
            
            <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../getting-started-guide/hashdata_warehouse_guide.html">1. 入门指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cluster-management-guide/cluster-management-guide.html">2. 管理指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer-guide/index.html">3. 开发指南</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">4. 最佳实践</a></li>
</ul>

            
        </div>

        
        <div class="wy-nav-content">
            <div class="rst-content">
                

<!-- -->
<!---->
<!---->

<!--<div role="navigation" aria-label="breadcrumbs navigation">-->
  <!--<ul class="wy-breadcrumbs">-->
    <!--<li><a href="../index.html">Docs</a> &raquo;</li>-->
      <!---->
          <!--<li><a href="index.html">4. 最佳实践</a> &raquo;</li>-->
      <!---->
    <!--<li>4.1.5. 第五章</li>-->
      <!--<li class="wy-breadcrumbs-aside">-->
        <!---->
          <!---->
            <!--<a href="../_sources/best-practices/chapter-5.rst.txt" rel="nofollow"> View page source</a>-->
          <!---->
        <!---->
      <!--</li>-->
  <!--</ul>-->
  <!--<hr/>-->
<!--</div>-->
                <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
                    <div itemprop="articleBody">
                        
  <div class="section" id="id1">
<h1>4.1.5. 第五章<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h1>
<div class="section" id="id2">
<h2>4.1.5.1. 系统监控和维护<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<p>本章介绍日常维护最佳实践以确保 HashData 数据仓库 数据仓库的高可用性和最佳性能。</p>
</div>
<div class="section" id="id3">
<h2>4.1.5.2. 监控<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<p>HashData 数据仓库 数据仓库带有一套系统监控工具。</p>
<p><em>gp_toolkit</em> 模式包含可以查询系统表、日志和操作环境状态的视图，使用 SQL 命令可以访问这些视图。</p>
<p><em>gp_stats_missing</em> 视图可以显示没有统计信息、需要运行 ANALYZE 的表。</p>
<p>关于 <em>gpstate</em> 和 <em>gpcheckperf</em> 的更多信息，请参考 《HashData 数据仓库 数据仓库工具指南》。关于 <em>gp_toolkit</em> 模式的更多信息，请参考《HashData 数据仓库 数据仓库参考指南》。</p>
<div class="section" id="gpstate">
<h3>4.1.5.2.1. gpstate<a class="headerlink" href="#gpstate" title="永久链接至标题">¶</a></h3>
<p>gpstate工具显示了 HashData 数据仓库 数据仓库的系统状态，包括哪些段数据库(Segments)宕机，主服务器(Master)和Segment的配置信息（主机、数据目录等），系统使用的端口和Segments的镜像信息。</p>
<p>运行 gpstate -Q 列出Master系统表中标记为“宕机”的Segments。</p>
<p>使用 gpstate -s 显示 HashData 数据仓库 集群的详细状态信息。</p>
</div>
<div class="section" id="gpcheckperf">
<h3>4.1.5.2.2. gpcheckperf<a class="headerlink" href="#gpcheckperf" title="永久链接至标题">¶</a></h3>
<p><em>gpcheckperf</em> 工具测试给定主机的基本硬件性能。其结果可以帮助识别硬件问题。它执行下面的检查：</p>
<ul class="simple">
<li>磁盘I/O测试 - 使用操作系统的 dd 命令读写一个大文件，测试磁盘的IO性能。它以每秒多少兆包括读写速度。</li>
<li>内存带宽测试 - 使用 STREAM 基准程序测试可持续的内存带宽。</li>
<li>网络性能测试 - 使用 <em>gpnetbench</em> 网络基准程序（也可以用 <em>netperf</em>）测试网络性能。测试有三种模式：并行成对测试（-r N）,串行成对测试（-r n），全矩阵测试（-r M）。测试结果包括传输速率的最小值、最大值、平均数和中位数。</li>
</ul>
<p>运行 <em>gpcheckperf</em> 时数据库必须停止。如果系统不停止，即使没有查询，<em>gpcheckperf</em> 的结果也可能不精确。</p>
<p><em>gpcheckperf</em> 需要在待测试性能的主机间建立可信无密码SSH连接。它会调用 <em>gpssh</em> 和 <em>gpscp</em>，所以这两个命令必须在系统路径PATH中。可以逐个指定待测试的主机（-h host1 -h host2 …）或者使用 -f hosts_file，其中 hosts_file 是包含待测试主机信息的文件。如果主机有多个子网，则为每个子网创建一个主机文件，以便可以测试每个子网。</p>
<p>默认情况下，<em>gpcheckperf</em> 运行磁盘I/O测试、内存测试和串行成对网络性能测试。对于磁盘测试，必须使用-d选项指定要测试的文件系统路径。下面的命令测试文件subnet_1_hosts中主机的磁盘和内存性能：</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ gpcheckperf -f subnet_1_hosts -d /data1 -d /data2 -r ds
</pre></div>
</div>
<p>-r选项指定要运行的测试：磁盘IO（d），内存带宽（s），网络并行成对测试（N），网络串行成对测试（n），网络全矩阵测试（M）。只能选择一种网络测试模式。更多信息，请参考《HashData 数据仓库 数据仓库参考指南》。</p>
</div>
<div class="section" id="id4">
<h3>4.1.5.2.3. 使用操作系统工具监控<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h3>
<p>下面的Linux/Unix 工具可用于评估主机性能：</p>
<ul class="simple">
<li>iostat监控段数据库(Segments)的磁盘活动</li>
<li>top显示操作系统进程的动态信息</li>
<li>vmstate显示内存使用情况的统计信息</li>
</ul>
<p>可以使用gpssh在多个主机上运行这些命令。</p>
</div>
<div class="section" id="id5">
<h3>4.1.5.2.4. 最佳实践<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h3>
<ul class="simple">
<li>实现《HashData 数据仓库 数据仓库管理员指南》中推荐的监控和维护任务。</li>
<li>安装前运行 <em>gpcheckperf</em>，此后周期性运行 <em>gpcheckperf</em>，并保存每次的结果，以用于比较系统随着时间推移的性能变化。</li>
<li>使用一切可用的工具来更好地理解系统在不同负载下的行为。</li>
<li>检查任何异常事件并确定原因。</li>
<li>通过定期运行解释计划监控系统查询活动，以确保查询处于最佳运行状态。</li>
<li>检查查询计划，以确定是否按预期使用了索引和进行了分区裁剪。</li>
</ul>
</div>
<div class="section" id="id6">
<h3>4.1.5.2.5. 额外信息<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h3>
<ul class="simple">
<li>《<a href="#id7"><span class="problematic" id="id8">|</span></a>product-name|数据仓库工具指南》中 <em>gpcheckperf</em></li>
<li>《<a href="#id9"><span class="problematic" id="id10">|</span></a>product-name|数据仓库管理员指南》中“监控和维护任务建议”</li>
<li>Sustainable Memory Bandwidth in Current High Performance Computers. John D. McCalpin. Oct 12, 1995.</li>
<li>关于netperf，可参考www.netperf.org，需要在每个待测试的主机上安装netperf。 参考gpcheckperf指南获的更多信息。</li>
</ul>
</div>
</div>
<div class="section" id="analyze">
<h2>4.1.5.3. 使用ANALYZE更新统计信息<a class="headerlink" href="#analyze" title="永久链接至标题">¶</a></h2>
<p>良好查询性能的最重要前提是精确的表数据统计信息。使用 ANALYZE 语句更新统计信息后，优化器可以选取最优的查询计划。分析完表数据后，相关统计信息保存在系统表中。如果系统表存储的信息过时了，优化器可能生成低效的计划。</p>
<div class="section" id="id11">
<h3>4.1.5.3.1. 选择性统计<a class="headerlink" href="#id11" title="永久链接至标题">¶</a></h3>
<p>不带参数运行 ANALYZE 会更新数据库中所有表的统计信息。这可能非常耗时，不推荐这样做。当数据发生变化时，建议对变化的表进行 ANALYZE。</p>
<p>对大表执行ANALYZE可能较为耗时。如果对大表的所有列运行 ANALYZE 不可行，则使用 ANALYZE table(column, …) 仅为某些字段生成统计信息。确保包括关联、WHERE子句、SORT子句、GROUP BY子句、HAVING子句中使用的字段。</p>
<p>对于分区表，可以只ANALYZE发生变化的分区，譬如只分析新加入的分区。注意可以ANALYZE分区表的父表或者最深子表。统计数据和用户数据一样，存储在最深子表中。中间层子表既不保存数据，也不保存统计信息，因而ANALYZE 它们没有效果。可以从系统表pg_partitions中找到分区表的名字。</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">partitiontablename</span> <span class="kn">from</span> <span class="nn">pg_partitions</span> <span class="n">WHERE</span> <span class="n">tablename</span><span class="o">=</span><span class="s1">&#39;parent_table;</span>
</pre></div>
</div>
</div>
<div class="section" id="id12">
<h3>4.1.5.3.2. 提高统计数据质量<a class="headerlink" href="#id12" title="永久链接至标题">¶</a></h3>
<p>需要权衡生成统计信息所需时间和统计信息的质量（或者精度）。</p>
<p>为了在合理的时间内完成大表的分析，ANALYZE对表内容随机取样，而不是分析每一行。调整配置参数 <em>default_statistics_target</em> 可以改变采样率。其取值范围为1到1000；默认是25。 默认 <em>default_statistics_target</em> 影响所有字段。较大的值会增加ANALYZE的时间，然而会提高优化器的估算质量。对于那些数据模式不规则的字段更是如此。可以在 主服务器(Master) 的会话中设置该值，但是需要重新加载。</p>
<p>配置参数 <em>gp_analyze_relative_error</em> 会影响为确定字段基数而收集的统计信息的采样率。例如 0.5 表示可以接受 50% 的误差。默认值是 0.25。使用 <em>gp_analyze_relative_error</em> 设置表基数估计的可接受的相对误差。如果统计数据不能产生较好的基数估计，则降低相对误差率（接受更少的错误）以采样更多的行。然而不建议该值低于0.1，否则会大大延长ANALYZE的时间。</p>
</div>
<div class="section" id="id13">
<h3>4.1.5.3.3. 何时运行ANALYZE<a class="headerlink" href="#id13" title="永久链接至标题">¶</a></h3>
<p>运行 ANALYZE 的时机包括：</p>
<ul class="simple">
<li>加载数据后</li>
<li>CREATE INDEX 操作后</li>
<li>影响大量数据的 INSERT、UPDATE 和 DELETE 操作后</li>
</ul>
<p>ANALYZE 只需对表加读锁，所以可以与其他数据库操作并行执行，但是在数据加载和执行 INSERT/UPDATE/DELETE/CREATE INDEX 操作时不要运行 ANALYZE。</p>
</div>
<div class="section" id="id14">
<h3>4.1.5.3.4. 自动统计<a class="headerlink" href="#id14" title="永久链接至标题">¶</a></h3>
<p>配置参数 <em>gp_autostats_mode</em> 和 <em>gp_autostats_on_change_threshold</em> 确定何时触发自动分析操作。当自动统计数据收集被触发后，planner 会自动加入一个 ANALYZE 步骤。</p>
<p><em>gp_autostats_mode</em> 默认设置是on_no_stats，如果表没有统计数据，则CREATE TABLE AS SELECT, INSERT, COPY操作会触发自动统计数据收集。</p>
<p>如果 <em>gp_autostats_mode</em> 是on_change，则仅当更新的行数超过 <em>gp_autostats_on_change_threshold</em> 定义的阈值时才触发统计信息收集，其默认值是2147483647。这种模式下，可以触发自动统计数据收集的操作有：CREATE TABLE AS SELECT, UPDATE, DELETE, INSERT 和 COPY。</p>
<p>设置 <em>gp_autostats_mode</em> 为none将禁用自动统计信息收集功能。</p>
<p>对分区表，如果从最顶层的父表插入数据不会触发统计信息收集。如果数据直接插入到叶子表（实际存储数据的表），则会触发统计信息收集。</p>
</div>
</div>
<div class="section" id="bloat">
<h2>4.1.5.4. 管理数据库臃肿（Bloat）<a class="headerlink" href="#bloat" title="永久链接至标题">¶</a></h2>
<p>HashData 数据仓库 数据仓库的堆表使用PostgreSQL的多版本并发控制（MVCC）的存储实现方式。删除和更新的行仅仅是逻辑删除，其实际数据仍然存储在表中，只是不可见。这些删除的行，也称为过期行，由空闲空间映射表（FSM, Free Space Map）记录。VACUUM标记这些过期的行为空闲空间，并可以被后续插入操作重用。</p>
<p>如果某个表的FSM不足以容纳所有过期的行，VACUUM命令无法回收溢出FSM的过期行空间。这些空间只能由VACUUM FULL回收，VACUUM FULL会锁住整个表，逐行拷贝到文件头部，并截断（TRUNCATE）文件。对于大表，这一操作非常耗时。仅仅建议对小表执行这种操作。如果试图杀死VACUUM FULL进程，系统可能会被破坏。</p>
<p>注意：
大型 UPDATE 和 DELETE 操作之后务必运行 VACUUM，避免运行 VACUUM FULL。</p>
<p>如果出现FSM溢出，需要回收空间，则建议使用 CREATE TABLE…AS SELECT 命令拷贝数据到新表，删除原来的表，然后重命名新表为原来的名字。</p>
<p>频繁更新的表会有少量过期行和空闲空间，空闲空间可被新加入的数据重用。但是当表变得非常大，而可见数据只占整体空间的一小部分，其余空间被过期行占用时，称之为臃肿（bloated）。臃肿表占用更多空间，需要更多I/O，因而会降低查询效率。</p>
<p>臃肿会影响堆表、系统表和索引。</p>
<p>周期性运行VACUUM可以避免表增长的过大。如果表变得非常臃肿，必须使用VACUUM FULL语句（或者其方法）精简该表。如果大表变得非常臃肿，则建议使用消除数据臃肿（后续章节）中介绍的方法消除臃肿的表。</p>
<p>警告：切勿运行 VACUUM FULL &lt;database_name&gt; 或者对大表运行 VACUUM FULL
FSM大小
运行VACUUM时，堆表的过期行被加入到共享的空闲空间映射表中。FSM必须足够容纳过期行。</p>
<p>如果不够大，则溢出FSM的空间不能被VACUUM回收。必须使用VACUUM FULL或者其他方法回收溢出空间。</p>
<p>定期性运行VACUUM可以避免FSM溢出。表越臃肿，FSM就需要记录越多的行。对于非常大的具有很多对象的数据库，需要增大 FSM 以避免溢出。</p>
<p>配置参数 <em>max_fsm_pages</em> 设置在共享空闲空间映射表中被FSM跟踪的磁盘页最大数目。一页占用6个字节共享空间。默认值是 200,000。</p>
<p>配置参数 <em>max_fsm_relations</em> 设置在共享空间映射表中被FSM跟踪的表的最大数目。该值需要大于数据库中堆表、索引和系统表的总数。每个段数据库的每个表占用60个字节的共享内存。默认值是1000。</p>
<p>更详细的信息，请参考《<a href="#id15"><span class="problematic" id="id16">|</span></a>product-name|数据仓库参考指南》。</p>
<div class="section" id="id17">
<h3>4.1.5.4.1. 检测臃肿<a class="headerlink" href="#id17" title="永久链接至标题">¶</a></h3>
<p>ANALYZE收集的统计信息可用于计算存储一个表所期望的磁盘页数。期望的页数和实际页数之间的差别是膨胀程度的一个度量。gp_toolkit模式的gp_bloat_diag视图通过比较期望页数和实际页数的比例识别膨胀的表。使用这个视图前，确保数据库的统计信息是最新的，然后运行下面的SQL：</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="n">gpadmin</span><span class="o">=#</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">gp_toolkit</span><span class="p">.</span><span class="n">gp_bloat_diag</span><span class="p">;</span>
 <span class="n">bdirelid</span> <span class="o">|</span> <span class="n">bdinspname</span> <span class="o">|</span> <span class="n">bdirelname</span> <span class="o">|</span> <span class="n">bdirelpages</span> <span class="o">|</span> <span class="n">bdiexppages</span> <span class="o">|</span>
 <span class="n">bdidiag</span>
<span class="c1">---------+------------+------------+-------------+-------------</span>
<span class="o">+</span><span class="c1">------------</span>
    <span class="mi">21488</span> <span class="o">|</span>     <span class="k">public</span> <span class="o">|</span>         <span class="n">t1</span> <span class="o">|</span>          <span class="mi">97</span> <span class="o">|</span>           <span class="mi">1</span> <span class="o">|</span> <span class="n">significant</span> <span class="n">amount</span>
<span class="k">of</span> <span class="n">bloat</span> <span class="n">suspected</span>
<span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>
</pre></div>
</div>
<p>结果中包括中度或者严重膨胀的表。实际页数与期望页数之比位于4和10之间是中度膨胀，大于10为严重膨胀。</p>
<p>视图gp_toolkit.gp_bloat_expected_pages列出每个数据库对象实际使用的页数和期望使用的磁盘页数。</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="n">gpadmin</span><span class="o">=#</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">gp_toolkit</span><span class="p">.</span><span class="n">gp_bloat_expected_pages</span> <span class="k">LIMIT</span> <span class="mi">5</span><span class="p">;</span>
 <span class="n">btdrelid</span> <span class="o">|</span> <span class="n">btdrelpages</span> <span class="o">|</span> <span class="n">btdexppages</span>
<span class="c1">---------+-------------+-------------</span>
    <span class="mi">10789</span> <span class="o">|</span>           <span class="mi">1</span> <span class="o">|</span>           <span class="mi">1</span>
    <span class="mi">10794</span> <span class="o">|</span>           <span class="mi">1</span> <span class="o">|</span>           <span class="mi">1</span>
    <span class="mi">10799</span> <span class="o">|</span>           <span class="mi">1</span> <span class="o">|</span>           <span class="mi">1</span>
     <span class="mi">5004</span> <span class="o">|</span>           <span class="mi">1</span> <span class="o">|</span>           <span class="mi">1</span>
     <span class="mi">7175</span> <span class="o">|</span>           <span class="mi">1</span> <span class="o">|</span>           <span class="mi">1</span>
<span class="p">(</span><span class="mi">5</span> <span class="k">rows</span><span class="p">)</span>
</pre></div>
</div>
<p>btdrelid是表的对象ID。btdrelpages字段表示表适用的实际页数；bdtexppages字段表示期望的页数。注意，这些数据基于统计信息，确保表发生变化后运行ANALYZE。</p>
</div>
<div class="section" id="id18">
<h3>4.1.5.4.2. 消除数据臃肿表<a class="headerlink" href="#id18" title="永久链接至标题">¶</a></h3>
<p>VACUUM命令将过期行加入到空闲空间映射表中以便以后重用。如果对频繁更新的表定期运行VACUUM，过期行占用的空间可以被及时的回收并重用，避免表变得非常大。同样重要的是在 FSM 溢出前运行VACUUM。对更新异常频繁的表，建议至少每天运行一次VACUUM以防止表变得臃肿。</p>
<p>警告：如果表严重臃肿，建议运行 VACUUM 前运行 ANALYZE。因为 ANALYZE使用块级别抽样，如果一个表中无效/有效行的块的比例很高，则ANALYZE会设置系统表 pg_class 的reltuples 字段为不精确的值或者0，这会导致查询优化器不能生成最优查询。VACUUM命令设置的数值更精确，如果在 ANALYZE 之后运行可以修正不精确的行数估计。</p>
<p>如果一个表膨胀严重，运行VACUUM命令是不够的。对于小表，可以通过VACUUM FULL 回收溢出 FSM 的空间，降低表的大小。然而VACUUM FULL操作需要ACCESS EXCLUSIVE锁，可能需要非常久或者不可预测的时间才能完成。注意，消除大表膨胀的每种方法都是资源密集型操作，只有在极端情况下才使用。</p>
<p>第一种方法是创建大表拷贝，删掉原表，然后重命名拷贝。这种方法使用CREATE TABLE AS SELECT创建新表，例如：</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="n">gpadmin</span><span class="o">=#</span> <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">mytable_tmp</span> <span class="k">AS</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">mytable</span><span class="p">;</span>
<span class="n">gpadmin</span><span class="o">=#</span> <span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">mytable</span><span class="p">;</span>
<span class="n">gpadmin</span><span class="o">=#</span> <span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">mytabe_tmp</span> <span class="k">RENAME</span> <span class="k">TO</span> <span class="n">mytable</span><span class="p">;</span>
</pre></div>
</div>
<p>第二种消除臃肿的方法是重分布。步骤为：</p>
<p>1.记录表的分布键</p>
<p>2.修改表的分布策略为随机分布</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">mytable</span> <span class="k">SET</span> <span class="k">WITH</span> <span class="p">(</span><span class="n">REORGANIZE</span><span class="o">=</span><span class="k">false</span><span class="p">)</span>
<span class="n">DISTRIBUTED</span> <span class="n">randomly</span><span class="p">;</span>
</pre></div>
</div>
<p>此命令修改表的分布策略，但是不会移动数据。这个命令会瞬间完成。</p>
<p>3.改回原来的分布策略</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">mytable</span> <span class="k">SET</span> <span class="k">WITH</span> <span class="p">(</span><span class="n">REORGANIZE</span><span class="o">=</span><span class="k">true</span><span class="p">)</span>
<span class="n">DISTRIBUTED</span> <span class="k">BY</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">original</span> <span class="n">distribution</span> <span class="n">columns</span><span class="o">&gt;</span><span class="p">);</span>
</pre></div>
</div>
<p>此命令会重新分布数据。因为和原来的分布策略相同，所以仅会在同一个段数据库上重写数据，并去掉过期行。</p>
</div>
<div class="section" id="id19">
<h3>4.1.5.4.3. 消除系统表臃肿<a class="headerlink" href="#id19" title="永久链接至标题">¶</a></h3>
<p>HashData 数据仓库 数据仓库系统表也是堆表，因而也会随着时间推移而变得臃肿。随着数据库对象的创建、修改和删除，系统表中会留下过期行。</p>
<p>使用gpload加载数据会造成臃肿，因为它会创建并删除外部表。（建议使用gpfdist加载数据）。</p>
</div>
<div class="section" id="id20">
<h3>4.1.5.4.4. 系统表膨胀<a class="headerlink" href="#id20" title="永久链接至标题">¶</a></h3>
<p>会拉长表扫描所需的时间，例如生成解释计划时。系统表需要频繁扫描，如果它们变得臃肿，那么系统整体性能会下降。</p>
<p>建议每晚(至少每周)对系统表运行VACUUM。</p>
<p>下面的脚本对系统表运行VACUUM ANALYZE。</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>#!/bin/bash
DBNAME=&quot;&lt;database_name&gt;&quot;
VCOMMAND=&quot;VACUUM ANALYZE&quot;psql -tc &quot;select &#39;$VCOMMAND&#39; || &#39; pg_catalog.&#39; || relname || &#39;;&#39;FROM pg_class a, pg_namespace b \
where a.relnamespace=b.oid andb.nspname=&#39;pg_catalog&#39; and a.relkind=&#39;r&#39;&quot;
$DBNAME | psql -a $DBNAME
</pre></div>
</div>
<p>如果系统表变得异常臃肿，则必须执行一次集中地系统表维护操作。对系统表不能使用CREATE TABLE AS SELECT和上面介绍的重分布方法消除臃肿，而只能在计划的停机期间，运行VACUUM FULL。在这个期间，停止系统上的所有系统表操作，VACUUM FULL会对系统表使用排它锁。定期运行VACUUM可以防止这一代价高昂的操作。</p>
</div>
<div class="section" id="id21">
<h3>4.1.5.4.5. 消除索引表臃肿<a class="headerlink" href="#id21" title="永久链接至标题">¶</a></h3>
<p>VACUUM命令仅恢复数据表的空间，要恢复索引表的空间，使用REINDEX重建索引。
使用REINDEX table_name重建一个表的所有索引；使用REINDEX index_name重建某个索引。</p>
</div>
<div class="section" id="ao">
<h3>4.1.5.4.6. 消除AO表臃肿<a class="headerlink" href="#ao" title="永久链接至标题">¶</a></h3>
<p>AO 表的处理方式和堆表完全不同。尽管AO表可以更新和删除，然而AO表不是为此而优化的，建议对AO表避免使用更新和删除。如果AO表用于一次加载/多次读取的业务，那么AO表的VACUUM操作几乎会立即返回。</p>
<p>如果确实需要对AO表执行UPDATE或者DELETE，则过期行会记录在辅助的位图表中，而不是像堆表那样使用空闲空间映射表。使用VACUUM回收空间。对含有过期行的AO表运行VACUUM会通过重写来精简整张表。如果过期行的百分比低于配置参数*gp_appendonly_compaction_threshold*, 则不会执行任何操作，默认值是10（10%）。每个段数据库(Segment)上都会检查该值，所以有可能某些Segment上执行空间回收操作，而另一些Segment不执行任何操作。可以通过设置*gp_appendonly_compaction* 参数为no禁止AO表空间回收。</p>
<p>监控|product-name|数据仓库日志文件</p>
<p>了解系统日志文件的位置和内容，并定期的监控这些文件。</p>
<p>下标列出了|product-name|数据仓库各种日志文件的位置。文件路径中，date是格式为 YYYYMMDD 的日期，instance是当前实例的名字，n是Segment号。</p>
<table border="1" class="docutils">
<colgroup>
<col width="73%" />
<col width="27%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">路径</th>
<th class="head">描述</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>/var/gpadmin/gpadminlogs/*</td>
<td>很多不同类型的日志文件</td>
</tr>
<tr class="row-odd"><td>/var/gpadmin/gpadminlogs/gpstart_date.log</td>
<td>启动日志</td>
</tr>
<tr class="row-even"><td>/var/gpadmin/gpadminlogs/gpstop_date.log</td>
<td>停止服务器日志</td>
</tr>
<tr class="row-odd"><td>/var/gpadmin/gpadminlogs/gpsegstart.py_idb*gpadmin_date.log</td>
<td>Segment  启动日志</td>
</tr>
<tr class="row-even"><td>/var/gpadmin/gpadminlogs/gpsegstop.py_idb*gpadmin_date.log</td>
<td>Segment  停止日志</td>
</tr>
<tr class="row-odd"><td>/var/gpdb/instance/dataMaster/gpseg-1/pg_log/startup.log</td>
<td>实例启动日志</td>
</tr>
<tr class="row-even"><td>/var/gpdb/instance/dataMaster/gpseg-1/gpperfmon/logs/gpmon.*.log</td>
<td>Gpperfmon日志</td>
</tr>
<tr class="row-odd"><td>/var/gpdb/instance/datamirror/gpseg{n}/pg_log/.*csv</td>
<td>镜像Segment日志</td>
</tr>
<tr class="row-even"><td>/var/gpdb/instance/dataprimary/gpseg{n}/pg_log/.*csv</td>
<td>主Segment日志</td>
</tr>
<tr class="row-odd"><td>/var/log/messages</td>
<td>Linux系统日志</td>
</tr>
</tbody>
</table>
<p>首先使用 gplogfilter -t(–trouble) 从Master日志中搜索 ERROR:, FATAL:, PANIC: 开头的消息。WARNING 开头的消息也可能提供有用的信息。</p>
<p>若需搜索段数据库（Segment）日志，从主服务器（Master）上使用gpssh连接到Segment上，然后使用gplogfilter工具搜索消息。可以通过Segment_id 识别是哪个 Segment的日志。</p>
<p>配置参数 <em>log_rotation_age</em> 控制什么时候会创建新的日志文件。默认情况下，每天创建一个新的日志文件。</p>
</div>
</div>
</div>


                    </div>
                </div>
                <footer> 

</footer>

            </div>
        </div>

    </section>

</div>


</div>



<script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
        URL_ROOT:'../',
        VERSION:'1.0.0',
        COLLAPSE_INDEX:false,
        FILE_SUFFIX:'.html',
        HAS_SOURCE:  true
    };
</script>
<script type="text/javascript" src="../_static/jquery.js"></script>
<script type="text/javascript" src="../_static/underscore.js"></script>
<script type="text/javascript" src="../_static/doctools.js"></script>
<script type="text/javascript" src="../_static/translations.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>





<script type="text/javascript" src="../_static/js/theme.js"></script>

<script src="../_static/js/bootstrap/bootstrap.min.js"></script>
<script>

$(function() {
    var triIcon = "../_static/img/tri-icon.png";
    $('.document .section h2').append( '<img src=' + triIcon + ' />' );
    $('.document .section h2').click(function() {
        $(this).parent().toggleClass('closed');
    });
});

$(function(){
    $('#m-nav-btn, #m-index li').click(function(e){
            $('#m-index').slideToggle(300, function(){
                $('#m-index').css('display') == "block" ?
                $('#m-header').css('background-color','#fff') :
                $('#m-header').css('background-color','rgba(255,255,255,0.9)');
            });
        });
        $('#content, #m-footer').click(function(){
            $('#m-index').slideUp();
            $('#m-header').css('background-color','rgba(255,255,255,0.9)')
        });

    /*
    $('.topLevel .toctree-l1 a.reference').each(function(index, ele) {
        var contentStr = ele. innerHTML;
        var aSet = new Set(['1.', '2.', '3.']);
        if (aSet.has(contentStr.substr(0,2)))
            ele.innerHTML = contentStr.substr(2);
    });
    */

});

</script>



<script type="text/javascript">
    jQuery(function () {
        SphinxRtdTheme.StickyNav.enable();
    });
</script>



<div id="footer">
    <footer id="footer-1">
	<div class="container">
	    <div class="footer-block col-lg-3 col-lg-offset-2 col-md-4 col-md-offset-1 col-sm-5 col-xs-5">
		<div class="logo">
		    <img src="../_static/img/footer-logo.png"/>
		</div>
		<p>北京酷克数据科技有限公司</p>
		<p>地址：北京市朝阳区望京博泰国际A座1506</p>
	    </div>
	    <div class="footer-block col-lg-3 col-md-4 col-sm-5 col-xs-5">
		<p class="title">联系地址</p>
		<p>电话：010-64710206</p>
		<p>微博：@HashData</p>
		<p>邮件：business@hashdata.cn</p>
	    </div>
	    <div class="footer-block qrcode col-lg-3 col-md-3">
		<p class="title">微信公众号</p>
		<img src="../_static/img/qrcode.png"/>
	    </div>
	</div>
    </footer>
    <footer id="footer-2">
	<p>Copyright © 2016 HashData Ltd. 京ICP备16019672号-1</p>
	<p><span class="emblem"></span>京公安网备11010502031309号</p>
    </footer>
</div>

<div id="m-footer">
    <div id="m-footer-bg"></div>
    <footer id="footer-1">
	<div class="logo"><img src="../_static/img/footer-logo.png" /></div>
	<div class="address">
	    <p>北京酷克数据科技有限公司</p>
	    <p>地址：北京市朝阳区望京博泰国际A座1506</p>
	</div>
	<div class="connect">
	    <p class="title">联系地址</p>
	    <p>电话：010-64710206</p>
	    <p>微博：@HashData</p>
	    <p>邮件：business@hashdata.cn</p>
	    <p>扫描二维码关注公众号：</p>
	    <div class="qrcode">
		<img src="../_static/img/qrcode.png"/>
	    </div>
	</div>
    </footer>
    <footer id="footer-2">
	<div class="copyright">
	    <p>Copyright © 2016 HashData Ltd. 京ICP备16019672号-1</p>
	    <p><span></span>京公安网备11010502031309号</p>
	</div>
    </footer>
</div>




</body>
</html>