

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
    <meta charset="utf-8">
    
    <meta name="viewport" content="width=375,user-scalable=no">
    
    <title>5.1.2. 数据订阅服务 开发指南 &mdash; HashData Warehouse Document 1.0.0 文档</title>
    

    
    

    

    
    
    

    

    
    
    <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
    

    

    
    <link rel="index" title="索引"
          href="../genindex.html"/>
    <link rel="search" title="搜索" href="../search.html"/>
    <link rel="top" title="HashData Warehouse Document 1.0.0 文档" href="../index.html"/>
    <link rel="up" title="5. 数据订阅服务" href="index.html"/>
    <link rel="prev" title="5.1.1. 数据订阅服务 入门指南" href="data_user_guide.html"/> 

    
    <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

    <div id="header">
        <header class="navbar navbar-static-top navbar-fixed-top" id="top" role="banner">
            <div class="container">
                <div class="navbar-header">
                    <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="http://www.hashdata.cn">
                        <img alt="Brand" src="../_static/img/logo.png">
                    </a>
                </div>
                <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
                    <ul class="nav navbar-nav navbar-right">
                        <li id="nav-index">
                            <a href="http://www.hashdata.cn">首页</a>
                        </li>
                        <li id="nav-product">
                            <a href="http://www.hashdata.cn/product">产品</a>
                        </li>
                        <li id="nav-case">
                            <a href="http://www.hashdata.cn/case">案例</a>
                        </li>
                        <li id="nav-blog">
                            <a href="http://www.hashdata.cn/blog">博客</a>
                        </li>
                        <li id="nav-doc" class="active">
                            <a href="http://www.hashdata.cn/docs">文档</a>
                        </li>
                        <li class="dropdown" id="nav-aboutus">
                            <a href="aboutus" class="dropdown-toggle" data-toggle="dropdown">酷克数据<span class="caret"></span></a>
                            <ul class="dropdown-menu" role="menu">
                                <li><a href="http://www.hashdata.cn/#block-aboutus-img">关于我们</a></li>
                                <li><a href="http://www.hashdata.cn/aboutus">加入我们</a></li>
                                <li> <a href="http://www.greenplum.net.cn/" target=_blank>社区</a></li>
                            </ul>
                        </li>
                        <li class="try">
			    <a target="_blank" href="https://appcenter.qingcloud.com/apps/app-iwacxg9z">点击试用</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </header>
    </div>

        <div id="m-header">
	    <nav id="m-nav">
		<button id="m-nav-btn">
		    <span class="icon-bar"></span>
		    <span class="icon-bar"></span>
		    <span class="icon-bar"></span>
		</button>
            <div class="wy-nav-top-search">
                
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <img src="../_static/img/search-icon.png" alt="search" />
    <input type="text" name="q" placeholder="搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
            </div>
	    </nav>
	    <div id="m-index">
		<ul>
		    <li class=""><a href="http://www.hashdata.cn/">首页</a></li>
		    <li class=""><a href="http://www.hashdata.cn/product">产品</a></li>
		    <li class=""><a href="http://www.hashdata.cn/case">案例</a></li>
		    <li class=""><a href="http://www.hashdata.cn/blog">博客</a></li>
		    <li class="active"><a href="http://www.hashdata.cn/docs">文档</a></li>
		    <li class=""><a href="http://www.hashdata.cn/#block-aboutus-img">关于我们</a></li>
		    <li class=""><a href="http://www.hashdata.cn/aboutus">加入我们</a></li>
		</ul>
	    </div>
	</div>


    <div id="content">

<div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
        <div class="wy-side-scroll">
            <div class="topLevel">
                
                
                
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../getting-started-guide/hashdata_warehouse_guide.html">1. 入门指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cluster-management-guide/cluster-management-guide.html">2. 管理指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer-guide/index.html">3. 开发指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../best-practices/index.html">4. 最佳实践</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">5. 数据订阅服务</a></li>
</ul>

                
                
            </div>

            <div class="wy-side-nav-search">
                

                <!---->
                <!--<a href="../index.html" class="icon icon-home"> HashData Warehouse Document-->
                <!---->

                <!---->
                <!--</a>-->

                <!---->
                <!---->
                <!---->
                <!---->
                <!--<div class="version">-->
                <!--1.0.0-->
                <!--</div>-->
                <!---->
                <!---->

                
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <img src="../_static/img/search-icon.png" alt="search" />
    <input type="text" name="q" placeholder="搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

                
            </div>

            <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                
                
                
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../getting-started-guide/hashdata_warehouse_guide.html">1. 入门指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cluster-management-guide/cluster-management-guide.html">2. 管理指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer-guide/index.html">3. 开发指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../best-practices/index.html">4. 最佳实践</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">5. 数据订阅服务</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html#id2">5.1. 数据订阅服务</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="data_user_guide.html">5.1.1. 数据订阅服务 入门指南</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">5.1.2. 数据订阅服务 开发指南</a></li>
</ul>
</li>
</ul>
</li>
</ul>

                
                
            </div>
        </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

        
        
        
        
        
        
        


        
        <div class="topLevel m-topLevel">
            
            
            <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../getting-started-guide/hashdata_warehouse_guide.html">1. 入门指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cluster-management-guide/cluster-management-guide.html">2. 管理指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer-guide/index.html">3. 开发指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../best-practices/index.html">4. 最佳实践</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">5. 数据订阅服务</a></li>
</ul>

            
        </div>

        
        <div class="wy-nav-content">
            <div class="rst-content">
                

<!-- -->
<!---->
<!---->

<!--<div role="navigation" aria-label="breadcrumbs navigation">-->
  <!--<ul class="wy-breadcrumbs">-->
    <!--<li><a href="../index.html">Docs</a> &raquo;</li>-->
      <!---->
          <!--<li><a href="index.html">5. 数据订阅服务</a> &raquo;</li>-->
      <!---->
    <!--<li>5.1.2. 数据订阅服务 开发指南</li>-->
      <!--<li class="wy-breadcrumbs-aside">-->
        <!---->
          <!---->
            <!--<a href="../_sources/data-subscription-guide/data_developer_guide.rst.txt" rel="nofollow"> View page source</a>-->
          <!---->
        <!---->
      <!--</li>-->
  <!--</ul>-->
  <!--<hr/>-->
<!--</div>-->
                <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
                    <div itemprop="articleBody">
                        
  <div class="section" id="data-developer-guide">
<span id="id1"></span><h1>5.1.2. 数据订阅服务 开发指南<a class="headerlink" href="#data-developer-guide" title="永久链接至标题">¶</a></h1>
<p>数据订阅服务 内部采用 Debezium 结合 Kafka 实现。Debezium 能够监控并且记录 MySQL 数据库的所有行级的变化。当它第一次连接到 MySQL 服务器的时候，它会读取所有数据库的一致性快照。快照完成之后，它会不断读取被提交到 MySQL 5.6 版本或之后版本数据库的数据变化，并且生成相应的 create、update 和 delete 事件。所有的事件都会按照数据库表分类到不同的 Kafka topic 中，然后再被其他应用或服务消费。</p>
<div class="section" id="id2">
<h2>5.1.2.1. 综述<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<p>MySQL 的二进制日志文件，即 binlog，按照提交顺序记录了所有的数据库操作，包括数据表的模式变化和表中数据的变化。MySQL 的复制和恢复以 binlog 为基础。</p>
<p>Debezium 能够读取并处理 MySQL 的二进制日志文件，从而获取数据改变的信息和事件发生的顺序。读取日志文件之后，它会对日志中每一个行级的 create、update 和 delete 操作生成一个对应的事件，并且将这些事件按照不同的表名存储到不同的 Kafka topic 中。用户的客户端应用可以读取相应表对应的 Kafka topic，获取事件信息，并且对每一个行级事件做出反馈。</p>
<p>MySQL 通常会设置为在一段时间后默认清理二进制日志文件，这意味着它的日志文件不会包含全部数据库变化的历史事件。因此，当 Debezium 首次连接到一个 MySQL 服务器，它会尝试获取每个数据库的一致性快照。当 Debezium 完成快照，它会从快照获取位置开始读取二进制日志文件。这样做能够保证不会丢失读取快照过程中数据库产生的变化事件，保证了数据一致性。</p>
<p>Debezium 具有很高的容错性。当它读取日志文件并且产生相应事件时，它会同时记录读取到的日志文件位置。如果 Debezium 由于某些原因停止工作（比如通信失败，网络错误），当重启的时候，它会直接从记录到的日志文件位置继续读取。</p>
</div>
<div class="section" id="mysql">
<h2>5.1.2.2. 配置 MySQL<a class="headerlink" href="#mysql" title="永久链接至标题">¶</a></h2>
<p>在 数据订阅服务 成功监控 MySQL 变化之前，必须配置 MySQL 使其采用行级日志模式，并且创建一个具有特定权限的数据库用户。</p>
<div class="section" id="binlog">
<h3>5.1.2.2.1. 配置 binlog<a class="headerlink" href="#binlog" title="永久链接至标题">¶</a></h3>
<p>采用行级二进制日志文件模式，更多细节可参考 <a class="reference external" href="http://dev.mysql.com/doc/refman/5.7/en/replication-options.html">MySQL 文档</a>。通常在 MySQL 服务器的配置文件里进行配置，并且和以下配置语句类似:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">server</span><span class="o">-</span><span class="nb">id</span>         <span class="o">=</span> <span class="mi">223344</span>
<span class="n">log_bin</span>           <span class="o">=</span> <span class="n">mysql</span><span class="o">-</span><span class="nb">bin</span>
<span class="n">binlog_format</span>     <span class="o">=</span> <span class="n">row</span>
<span class="n">binlog_row_image</span>  <span class="o">=</span> <span class="n">full</span>
<span class="n">expire_logs_days</span>  <span class="o">=</span> <span class="mi">10</span>
</pre></div>
</div>
<p>其中：</p>
<ul class="simple">
<li><strong>server-id</strong>：同一个集群中的每个MySQL服务器和复制客户端必须具有唯一的 server id。</li>
<li><strong>log_bin</strong>：二进制日志文件的 base name。</li>
<li><strong>binlog_format</strong>：必须为 <em>row</em> 或 <em>ROW</em>。</li>
<li><strong>binlog_row_image</strong>：必须为 <em>full</em> 或 <em>FULL</em>。</li>
<li><strong>expire_logs_days</strong>：自动清理日志文件的时间。默认值为0，意味着“不自动清理日志文件”，所以注意为你的环境设置合适的值。</li>
</ul>
</div>
<div class="section" id="id4">
<h3>5.1.2.2.2. 创建MySQL用户<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h3>
<p>创建的 MySQL 用户必须对 Debezium 要监控的数据库拥有以下权限：</p>
<ul class="simple">
<li><strong>SELECT</strong>：使得 Debezium 能够从表中选取行；仅当快照时使用。</li>
<li><strong>RELOAD</strong>：使得 Debezium 能够 <em>FLUSH</em> 声明去清理或重载各种内部缓存， <em>FLUSH</em> 表，或者获取锁；仅当快照时使用。</li>
<li><strong>SHOW DATABASES</strong>：使得 Debezium 能够通过 <em>SHOW DATABASE</em> 声明获取数据库名称；仅当快照时使用。</li>
<li><strong>REPLICATION SLAVE</strong>：使得 Debezium 能够连接到 MySQL 服务器并且读取二进制日志文件；总是需要。</li>
<li><strong>REPLICATION CLIENT</strong>：启用 <em>SHOW MASTER STATUS</em>， <em>SHOW SLAVE STATUS</em>，和 <em>SHOW BINARY LOGS</em>；总是需要。</li>
</ul>
<p>以下语句为示例，为用户名为 <em>debezium</em>，密码为 <em>dbz</em> 的用户赋予以上权限:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">GRANT</span> <span class="n">SELECT</span><span class="p">,</span> <span class="n">RELOAD</span><span class="p">,</span> <span class="n">SHOW</span> <span class="n">DATABASES</span><span class="p">,</span> <span class="n">REPLICATION</span> <span class="n">SLAVE</span><span class="p">,</span> <span class="n">REPLICATION</span> <span class="n">CLIENT</span> <span class="n">ON</span> <span class="o">*.*</span> <span class="n">TO</span> <span class="s1">&#39;debezium&#39;</span> <span class="n">IDENTIFIED</span> <span class="n">BY</span> <span class="s1">&#39;dbz&#39;</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id5">
<h2>5.1.2.3. 数据订阅服务 工作原理<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h2>
<p>这部分文档详细解释了 数据订阅服务 工作原理中的以下方面：</p>
<ul class="simple">
<li>追踪表结构的变化</li>
<li>读取二进制日志文件</li>
<li>把二进制日志文件的事件转化为 Debezium 的事件</li>
<li>错误处理</li>
</ul>
<div class="section" id="schema-history">
<h3>5.1.2.3.1. 数据库模式 Schema History<a class="headerlink" href="#schema-history" title="永久链接至标题">¶</a></h3>
<p>当一个数据库客户端对数据库发起一个查询请求，它会采用数据库当前的模式。但是数据库的模式随时可能改变，这意味着 Debezium 必须在每一个 create、update 和 delete 操作被记录的时刻都知道数据库的模式信息。它不能够直接使用当前的模式，因为它可能处理的是模式变化之前的旧信息。幸运的是，MySQL 在它的二进制日志文件里记录了数据库模式定义语言（DDL statements）。当 Debezium 读到这些 DDL 语句时，它会解析这些语句并在存储中更新一个相应的表的模式，它还会把所有的 DDL 语句和相应的所在二进制文件的位置记录到一个单独的 database history Kafka topic 中。</p>
<p>当 Debezium 在崩溃或正常停止后重启，它会从一个特定的位置或时间点开始读取日志文。Debezium 通过读取 database history Kafka topic 获取 DDL 语句来重建那个特定位置或时间点的数据表结构。</p>
<p>这个 database history topic 是仅仅为 Debezium 而设计的，Debezium 可以选择性地生成 <em>schema change events</em> 到另外一个专为消费者设计的 topic。这部分将在 <a class="reference internal" href="#schema-change-topic">Schema Change Topic</a> 部分详细阐述。</p>
</div>
<div class="section" id="schema-change-topic">
<span id="id6"></span><h3>5.1.2.3.2. 读取 MySQL 日志文件<a class="headerlink" href="#schema-change-topic" title="永久链接至标题">¶</a></h3>
<p>Debezium 把绝大多数运行时间花费在读取二进制日志文件上。</p>
<p>当 Debezium 读取日志文件时，它会把日志事件转化为 Debezium 的 create、updata 或 delete 事件，并包括该事件在日志文件中的位置。Debezium 会将这些事件发送给相应的 Kafka topic。Kafka 会读取 Debezium 记录在每个事件中的 <em>offset</em> 信息，并且周期性地在 Kafka topic 中更新最新的 <em>offset</em>。</p>
<p>当 Kafka 正常停止，它会停止依赖于它的 Debezium，把所有未提交的事件推送到 Kafka，并且记录每个 Debezium 收到的最后的 <em>offset</em>。重启时，Kafka 读取 Debezium 最后记录的 <em>offset</em> 信息，并且从该位置启动 Debezium。Debezium 用二进制日志文件名称和文件中的位置去请求 MySQL 从该位置开始发送日志文件事件信息。</p>
</div>
<div class="section" id="kafka-topics">
<h3>5.1.2.3.3. Kafka Topics<a class="headerlink" href="#kafka-topics" title="永久链接至标题">¶</a></h3>
<div class="section" id="topics">
<h4>5.1.2.3.3.1. Topics 名字<a class="headerlink" href="#topics" title="永久链接至标题">¶</a></h4>
<p>Debezium 把一个表的所有 create、update 和 delete 事件记录到一个单独的 Kafka topic 中。Kafka topic 的名字形式为 <em>namespace.databaseName.tableName</em>，其中 <em>namespace</em> 是启动服务时要求填写的 <em>namespace</em> 参数， <em>databaseName</em> 是数据库的名称， <em>tableName</em> 是数据表的名称。</p>
<p>比如，考虑一个名字为 <em>inverntory</em> 的数据库，它包括四张表： <em>products</em>， <em>products_on_hand</em>， <em>customers</em>，和 <em>orders</em>。如果这个数据库的 <em>namespace</em> 被配置为 <em>fulfillment</em>，那么这个 Connector 会把这四张表产生的事件分别生产到四个 Kafka topic 中：</p>
<ul class="simple">
<li><em>fulfillment.inventory.products</em></li>
<li><em>fulfillment.inventory.products_on_hand</em></li>
<li><em>fulfillment.inventory.customers</em></li>
<li><em>fulfillment.inventory.orders</em></li>
</ul>
</div>
<div class="section" id="id7">
<h4>5.1.2.3.3.2. Schema Change Topic<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h4>
<p>通常消费者会需要获取数据库模式改变的信息，Debezium 能够通过配置去生产 <em>schema change events</em>。当启用该配置时，Debezium 会把所有的数据库模式改变事件写入一个叫做 <em>namespace</em> 的 Kafka topic， <em>namespace</em> 就是前文中的 <em>namespace</em> 配置参数。在前文的例子中，模式改变事件会被记录到 topic <em>fulfillment</em> 中。</p>
</div>
</div>
<div class="section" id="events">
<h3>5.1.2.3.4. 事件 Events<a class="headerlink" href="#events" title="永久链接至标题">¶</a></h3>
<p>Debezium 产生的所有事件都有一个 key 和一个 value，key 和 value 的结构根据不同的表结构变化。所有消息的 key 和 value 都由两部分组成： <em>schema</em> 和 <em>payload</em>。 <em>schema</em> 描述 <em>payload</em> 的结构， <em>payload</em> 包含真正的信息。</p>
<div class="section" id="key">
<h4>5.1.2.3.4.1. 事件的 key<a class="headerlink" href="#key" title="永久链接至标题">¶</a></h4>
<p>对于一个给定的表，事件的 key 包括表的主键。比如 <em>inventory</em> 数据库中的 <em>customers</em> 表定义如下:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">customers</span> <span class="p">(</span>
  <span class="nb">id</span> <span class="n">INTEGER</span> <span class="n">NOT</span> <span class="n">NULL</span> <span class="n">AUTO_INCREMENT</span> <span class="n">PRIMARY</span> <span class="n">KEY</span><span class="p">,</span>
  <span class="n">first_name</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="n">NOT</span> <span class="n">NULL</span><span class="p">,</span>
  <span class="n">last_name</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="n">NOT</span> <span class="n">NULL</span><span class="p">,</span>
  <span class="n">email</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="n">NOT</span> <span class="n">NULL</span> <span class="n">UNIQUE</span> <span class="n">KEY</span>
<span class="p">)</span> <span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">1001</span><span class="p">;</span>
</pre></div>
</div>
<p>在这个定义下， <em>customers</em> 表的事件都有相同的 key，JSON 格式如下:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;struct&quot;</span><span class="p">,</span>
    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;mysql-server-1.inventory.customers.Key&quot;</span>
    <span class="s2">&quot;optional&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
    <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;int32&quot;</span><span class="p">,</span>
        <span class="s2">&quot;optional&quot;</span><span class="p">:</span> <span class="n">false</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">},</span>
  <span class="s2">&quot;payload&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1004</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>key 的 <em>schema</em> 部分描述了 <em>payload</em> 部分的内容，以上例子描述了 <em>payload</em> 是不可选的，并且被一个名字是 <em>mysql-server-1.inventory.customers.Key</em> 的结构所定义，其中有一个必须项叫做 <em>id</em>，它的类型是 <em>int32</em>。如果我们看下面的 <em>payload</em> 内容，可以看到它确实是一个只包含 <em>id</em> 的结构（也即 JSON 对象），它的值是 <em>1004</em>。</p>
<p>因此，我们可以认为这个 key 描述了 <em>inventory.customers</em> 表中的一行，这一行的 <em>id</em> 主键值是 <em>1004</em>，并且这个数据库的 <em>namespace</em> 是 <em>mysql-server-1</em>。</p>
<p>注意：如果一张表没有主键，那么它的事件的 key 会被设为 null。</p>
</div>
<div class="section" id="value">
<h4>5.1.2.3.4.2. 事件的 value<a class="headerlink" href="#value" title="永久链接至标题">¶</a></h4>
<p>相比事件的 key，它的 value 要复杂一些。同 key 结构类似，value 也包含一个 <em>schema</em> 部分和一个 <em>payload</em> 部分。从 Debezium 0.2 开始， <em>payload</em> 部分由一个叫做 <em>envelope</em> 的结构组成，这个结构包含如下项：</p>
<ul class="simple">
<li><strong>op</strong>：必须项，包括一个用来描述操作类型的字符串。 <em>c</em> 表示 crete 或 insert， <em>u</em> 表示 update， <em>d</em> 表示 delete， <em>r</em> 表示 read。</li>
<li><strong>before</strong>：可选项，描述这个事件发生前这一行的状态。它的结构由 <em>mysql-server-1.inventory.customers.Value</em> Kafka schema 描述，这个结构被用来描述 <em>inventory.customers</em> 表里的所有行。</li>
<li><strong>after</strong>：可选项，描述这个事件发生后这一行的状态。同上，它的结构由 <em>mysql-server-1.inventory.customers.Value</em> 描述。</li>
<li><strong>source</strong>：必须项，描述这个事件的 source metadata，在 MySQL 中包括如下项：Debezium 的连接器类型名称，事件记录的二进制日志文件名，事件在日志文件中的位置，事件中的哪一行（如果这个事件多于一行），这个事件是否是快照的一部分，以及如果可以获取的话，MySQL 的 server ID 和时间戳。</li>
<li><strong>ts_ms</strong>：可选项，描述 Debezium 处理这个事件的时间（使用的是运行 Kafka 的主机的系统时钟）。</li>
</ul>
<p>同样， value 的 <em>schema</em> 部分也由一个 <em>envelope</em> 结构组成。</p>
<p>如下是 <em>customer</em> 表中一个事件的 value:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;struct&quot;</span><span class="p">,</span>
    <span class="s2">&quot;optional&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;mysql-server-1.inventory.customers.Envelope&quot;</span><span class="p">,</span>
    <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
        <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;op&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
        <span class="s2">&quot;optional&quot;</span><span class="p">:</span> <span class="n">false</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;before&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;struct&quot;</span><span class="p">,</span>
        <span class="s2">&quot;optional&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;mysql-server-1.inventory.customers.Value&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;int32&quot;</span><span class="p">,</span>
            <span class="s2">&quot;optional&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
            <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;id&quot;</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
            <span class="s2">&quot;optional&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
            <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;first_name&quot;</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
            <span class="s2">&quot;optional&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
            <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;last_name&quot;</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
            <span class="s2">&quot;optional&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
            <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;email&quot;</span>
          <span class="p">}</span>
        <span class="p">]</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;after&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;struct&quot;</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;mysql-server-1.inventory.customers.Value&quot;</span><span class="p">,</span>
        <span class="s2">&quot;optional&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
        <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;int32&quot;</span><span class="p">,</span>
            <span class="s2">&quot;optional&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
            <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;id&quot;</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
            <span class="s2">&quot;optional&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
            <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;first_name&quot;</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
            <span class="s2">&quot;optional&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
            <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;last_name&quot;</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
            <span class="s2">&quot;optional&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
            <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;email&quot;</span>
          <span class="p">}</span>
        <span class="p">]</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;source&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;struct&quot;</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;io.debezium.connector.mysql.Source&quot;</span><span class="p">,</span>
        <span class="s2">&quot;optional&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
        <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
            <span class="s2">&quot;optional&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
            <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;name&quot;</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;int64&quot;</span><span class="p">,</span>
            <span class="s2">&quot;optional&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
            <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;server_id&quot;</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;int64&quot;</span><span class="p">,</span>
            <span class="s2">&quot;optional&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
            <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;ts_sec&quot;</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
            <span class="s2">&quot;optional&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
            <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;gtid&quot;</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">,</span>
            <span class="s2">&quot;optional&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
            <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;file&quot;</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;int64&quot;</span><span class="p">,</span>
            <span class="s2">&quot;optional&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
            <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;pos&quot;</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;int32&quot;</span><span class="p">,</span>
            <span class="s2">&quot;optional&quot;</span><span class="p">:</span> <span class="n">false</span><span class="p">,</span>
            <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;row&quot;</span>
          <span class="p">},</span>
          <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;boolean&quot;</span><span class="p">,</span>
            <span class="s2">&quot;optional&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
            <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;snapshot&quot;</span>
          <span class="p">}</span>
        <span class="p">]</span>
      <span class="p">},</span>
      <span class="p">{</span>
        <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;ts_ms&quot;</span><span class="p">,</span>
        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;int64&quot;</span><span class="p">,</span>
        <span class="s2">&quot;optional&quot;</span><span class="p">:</span> <span class="n">true</span>
      <span class="p">}</span>
    <span class="p">]</span>
  <span class="p">},</span>
  <span class="s2">&quot;payload&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;op&quot;</span><span class="p">:</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ts_ms&quot;</span><span class="p">:</span> <span class="mi">1465491411815</span><span class="p">,</span>
    <span class="s2">&quot;before&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
    <span class="s2">&quot;after&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1004</span><span class="p">,</span>
      <span class="s2">&quot;first_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Anne&quot;</span><span class="p">,</span>
      <span class="s2">&quot;last_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Kretchmar&quot;</span><span class="p">,</span>
      <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;annek@noanswer.org&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;mysql-server-1&quot;</span><span class="p">,</span>
      <span class="s2">&quot;server_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="s2">&quot;ts_sec&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="s2">&quot;gtid&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
      <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="s2">&quot;mysql-bin.000003&quot;</span><span class="p">,</span>
      <span class="s2">&quot;pos&quot;</span><span class="p">:</span> <span class="mi">154</span><span class="p">,</span>
      <span class="s2">&quot;row&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="s2">&quot;snapshot&quot;</span><span class="p">:</span> <span class="n">true</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>在 value 中的 <em>schema</em> 部分，我们可以看到 <em>envelope</em> 的 schema， <em>source</em> 的 schema（对每一个 MySQL 是特定的），和 <em>before</em> 以及 <em>after</em> 的 schema （对每一张表是特定的）。</p>
<p>在 value 的 <em>payload</em> 部分，我们可以看到这个事件的具体信息。以上例子描述了在表中创建一行（因为 <em>op = c</em>），并且 <em>after</em> 项中描述了新创建行的 <em>id</em>， <em>first_name</em>， <em>last_name</em> 和 <em>email</em>。</p>
<p>上面是 create 事件的 value 例子，同一张表的 update 事件的 value 会和以上 create 事件有完全相同 <em>schema</em>，它的 <em>payload</em> 会和 create 事件结构相同但值不同。例如:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="o">...</span> <span class="p">},</span>
  <span class="s2">&quot;payload&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;before&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1004</span><span class="p">,</span>
      <span class="s2">&quot;first_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Anne&quot;</span><span class="p">,</span>
      <span class="s2">&quot;last_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Kretchmar&quot;</span><span class="p">,</span>
      <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;annek@noanswer.org&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;after&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1004</span><span class="p">,</span>
      <span class="s2">&quot;first_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Anne Marie&quot;</span><span class="p">,</span>
      <span class="s2">&quot;last_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Kretchmar&quot;</span><span class="p">,</span>
      <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;annek@noanswer.org&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;mysql-server-1&quot;</span><span class="p">,</span>
      <span class="s2">&quot;server_id&quot;</span><span class="p">:</span> <span class="mi">223344</span><span class="p">,</span>
      <span class="s2">&quot;ts_sec&quot;</span><span class="p">:</span> <span class="mi">1465581</span><span class="p">,</span>
      <span class="s2">&quot;gtid&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
      <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="s2">&quot;mysql-bin.000003&quot;</span><span class="p">,</span>
      <span class="s2">&quot;pos&quot;</span><span class="p">:</span> <span class="mi">484</span><span class="p">,</span>
      <span class="s2">&quot;row&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="s2">&quot;snapshot&quot;</span><span class="p">:</span> <span class="n">null</span>
    <span class="p">},</span>
    <span class="s2">&quot;op&quot;</span><span class="p">:</span> <span class="s2">&quot;u&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ts_ms&quot;</span><span class="p">:</span> <span class="mi">1465581029523</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>比较 update 事件和 create 事件的 value，我们可以看到 update 在 <em>payload</em> 中和 create 有以下几点不同：</p>
<ul class="simple">
<li><em>op</em> 值为 <em>u</em>，表名这一行的改变是因为一个 update 操作</li>
<li><em>before</em> 值描述的是更新前这一行的信息</li>
<li><em>after</em> 值描述更新后这一行的信息，比如上面例子中更新后 <em>first_name</em> 值变成了 <em>Anne Marie</em></li>
<li><em>source</em> 的结构和之前一样，但是值有所不同，因为这两个事件在日志文件中的位置不同</li>
<li><em>ts_ms</em> 描述了 Debezium 处理这个事件的时间戳</li>
</ul>
<p>比较了 create 事件和 update 事件，接下来是 delete 事件。同样，value 的 <em>schema</em> 部分完全相同:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="o">...</span> <span class="p">},</span>
  <span class="s2">&quot;payload&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;before&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="mi">1004</span><span class="p">,</span>
      <span class="s2">&quot;first_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Anne Marie&quot;</span><span class="p">,</span>
      <span class="s2">&quot;last_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Kretchmar&quot;</span><span class="p">,</span>
      <span class="s2">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;annek@noanswer.org&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;after&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
    <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;mysql-server-1&quot;</span><span class="p">,</span>
      <span class="s2">&quot;server_id&quot;</span><span class="p">:</span> <span class="mi">223344</span><span class="p">,</span>
      <span class="s2">&quot;ts_sec&quot;</span><span class="p">:</span> <span class="mi">1465581</span><span class="p">,</span>
      <span class="s2">&quot;gtid&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
      <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="s2">&quot;mysql-bin.000003&quot;</span><span class="p">,</span>
      <span class="s2">&quot;pos&quot;</span><span class="p">:</span> <span class="mi">805</span><span class="p">,</span>
      <span class="s2">&quot;row&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="s2">&quot;snapshot&quot;</span><span class="p">:</span> <span class="n">null</span>
    <span class="p">},</span>
    <span class="s2">&quot;op&quot;</span><span class="p">:</span> <span class="s2">&quot;d&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ts_ms&quot;</span><span class="p">:</span> <span class="mi">1465581902461</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><em>payload</em> 部分，delete 与 create 和 update 有如下不同：</p>
<ul class="simple">
<li><em>op</em> 部分的值为 <em>d</em>，说明这一行被删除</li>
<li><em>before</em> 部分描述这一行删除前的信息</li>
<li><em>after</em> 部分为 null， 说明这一行不再存在</li>
<li><em>source</em> 部分和之前类似，不同的地方在于 <em>ts_sec</em> 和 <em>pos</em> 发生变化</li>
<li><em>ts_ms</em> 部分描述了 Debezium 处理这个时间的时间戳</li>
</ul>
<p>Debezium 的事件模式适用于 <a class="reference external" href="https://cwiki.apache.org/confluence/display/KAFKA/Log+Compaction">Kafka log compaction</a>，它允许 Kafka 删除一些旧信息，只要 Kafka 还保留着每一个 key 的最新信息。这使得 Kafka 可以在保证 Kafka topic 保存了数据集的所有信息的前提下，回收利用存储空间。</p>
<p>当一行被删除时，Kafka 可以移除和这个删除事件的 key 相同的所有之前事件信息，这通过一个 value 是 null 的特殊事件来实现。Debezium 在产生一个 delete 事件之后，会紧接着产生一个特殊的 <em>tombstone</em> 事件，这个事件的 value 为 null，Kafka 可以识别出这个事件并实现日志压缩。</p>
<p>当表中一行数据的主键信息被更新时，这一行事件的 key 的值发生变化，Debezium 处理的方式是产生三个事件：一个 delete 事件，一个包括旧的 key 值的 <em>tombstome</em> 事件，和一个包括新的 key 值的 insert 事件。</p>
</div>
</div>
<div class="section" id="id8">
<h3>5.1.2.3.5. 错误处理<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h3>
<p>当系统正常运行时，Debezium 提供 <em>exactly once delivery</em> 的事件处理模式。当错误发生时，为了保证信息不丢失，Debezium 可能会重复处理部分事件。因此在非正常情况下，Debezium 同 Kafka 一样采用 <em>at least once delivery</em> 的事件处理模式。</p>
<p>以下部分详细描述了 数据订阅服务 如何处理各种类型的错误。</p>
<div class="section" id="id9">
<h4>5.1.2.3.5.1. 配置与启动错误<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h4>
<p>当依赖的 Zookeeper 不可用，或依赖的 Kafka 不可用，或当 Debezium 无法成功连接到 MySQL（比如 MySQL ip 无法连接，用户名或密码错误），它会在日志中报错并停止运行。</p>
</div>
<div class="section" id="id10">
<h4>5.1.2.3.5.2. MySQL 错误<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h4>
<p>当服务正常运行过程中，它连接到的 MySQL 服务器发生错误，服务会在日志中报错并停止。当 MySQL 服务器恢复正常后，重启服务即可。</p>
</div>
<div class="section" id="kafka-connect">
<h4>5.1.2.3.5.3. Kafka Connect 进程错误<a class="headerlink" href="#kafka-connect" title="永久链接至标题">¶</a></h4>
<p>如果 Kafka Connect 进程意外停止，它运行的 Connector tasks 也会停止，并且不会记录到最新的 <em>offset</em> 信息。服务监测到 connector 和 task 的异常状态，会报错尝试重启服务。重启服务后，Debezium 会从之前记录的位置重新开始，所以有可能产生重复的事件。</p>
</div>
<div class="section" id="kafka-zookeeper">
<h4>5.1.2.3.5.4. Kafka 或 Zookeeper 服务错误<a class="headerlink" href="#kafka-zookeeper" title="永久链接至标题">¶</a></h4>
<p>当依赖的 Kafka 和 Zookeeper 服务发生错误，Connector 和 task 的状态均会变为异常，服务监测到异常状态会报出错误信息，并尝试重启服务。</p>
<blockquote>
<div><p>更多信息请参考：</p>
<ul class="simple">
<li><a class="reference external" href="http://debezium.io/docs/tutorial/">Debezium</a></li>
<li><a class="reference external" href="http://debezium.io/docs/connectors/mysql/">Debezium MySQL Connector</a></li>
<li><a class="reference external" href="http://kafka.apache.org/documentation/#gettingStarted">Kafka</a></li>
<li><a class="reference external" href="https://docs.confluent.io/current/connect/index.html">Kafka Connect</a></li>
</ul>
</div></blockquote>
</div>
</div>
</div>
</div>


                    </div>
                </div>
                <footer> 

</footer>

            </div>
        </div>

    </section>

</div>


</div>



<script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
        URL_ROOT:'../',
        VERSION:'1.0.0',
        COLLAPSE_INDEX:false,
        FILE_SUFFIX:'.html',
        HAS_SOURCE:  true
    };
</script>
<script type="text/javascript" src="../_static/jquery.js"></script>
<script type="text/javascript" src="../_static/underscore.js"></script>
<script type="text/javascript" src="../_static/doctools.js"></script>
<script type="text/javascript" src="../_static/translations.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>





<script type="text/javascript" src="../_static/js/theme.js"></script>

<script src="../_static/js/bootstrap/bootstrap.min.js"></script>
<script>

$(function() {
    var triIcon = "../_static/img/tri-icon.png";
    $('.document .section h2').append( '<img src=' + triIcon + ' />' );
    $('.document .section h2').click(function() {
        $(this).parent().toggleClass('closed');
    });
});

$(function(){
    $('#m-nav-btn, #m-index li').click(function(e){
            $('#m-index').slideToggle(300, function(){
                $('#m-index').css('display') == "block" ?
                $('#m-header').css('background-color','#fff') :
                $('#m-header').css('background-color','rgba(255,255,255,0.9)');
            });
        });
        $('#content, #m-footer').click(function(){
            $('#m-index').slideUp();
            $('#m-header').css('background-color','rgba(255,255,255,0.9)')
        });

    /*
    $('.topLevel .toctree-l1 a.reference').each(function(index, ele) {
        var contentStr = ele. innerHTML;
        var aSet = new Set(['1.', '2.', '3.']);
        if (aSet.has(contentStr.substr(0,2)))
            ele.innerHTML = contentStr.substr(2);
    });
    */

});

</script>



<script type="text/javascript">
    jQuery(function () {
        SphinxRtdTheme.StickyNav.enable();
    });
</script>



<div id="footer">
    <footer id="footer-1">
	<div class="container">
	    <div class="footer-block col-lg-3 col-lg-offset-2 col-md-4 col-md-offset-1 col-sm-5 col-xs-5">
		<div class="logo">
		    <img src="../_static/img/footer-logo.png"/>
		</div>
		<p>北京酷克数据科技有限公司</p>
		<p>地址：北京市朝阳区望京博泰国际A座1506</p>
	    </div>
	    <div class="footer-block col-lg-3 col-md-4 col-sm-5 col-xs-5">
		<p class="title">联系地址</p>
		<p>电话：010-64710206</p>
		<p>微博：@HashData</p>
		<p>邮件：business@hashdata.cn</p>
	    </div>
	    <div class="footer-block qrcode col-lg-3 col-md-3">
		<p class="title">微信公众号</p>
		<img src="../_static/img/qrcode.png"/>
	    </div>
	</div>
    </footer>
    <footer id="footer-2">
	<p>Copyright © 2016 HashData Ltd. 京ICP备16019672号-1</p>
	<p><span class="emblem"></span>京公安网备11010502031309号</p>
    </footer>
</div>

<div id="m-footer">
    <div id="m-footer-bg"></div>
    <footer id="footer-1">
	<div class="logo"><img src="../_static/img/footer-logo.png" /></div>
	<div class="address">
	    <p>北京酷克数据科技有限公司</p>
	    <p>地址：北京市朝阳区望京博泰国际A座1506</p>
	</div>
	<div class="connect">
	    <p class="title">联系地址</p>
	    <p>电话：010-64710206</p>
	    <p>微博：@HashData</p>
	    <p>邮件：business@hashdata.cn</p>
	    <p>扫描二维码关注公众号：</p>
	    <div class="qrcode">
		<img src="../_static/img/qrcode.png"/>
	    </div>
	</div>
    </footer>
    <footer id="footer-2">
	<div class="copyright">
	    <p>Copyright © 2016 HashData Ltd. 京ICP备16019672号-1</p>
	    <p><span></span>京公安网备11010502031309号</p>
	</div>
    </footer>
</div>




</body>
</html>